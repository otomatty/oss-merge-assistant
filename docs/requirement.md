## VS Code 拡張機能「OSS Merge Assistant」実装要件定義書

**バージョン:** 1.0  
**最終更新:** 2025 年 10 月 24 日  
**対象読者:** 開発チーム、プロダクトマネージャー

### 1. 概要

#### 1.1. 背景と目的

オープンソースソフトウェア（OSS）をベースとしたカスタマイズ開発において、開発者は「上流 OSS への追従」「独自カスタマイズ部分のメンテナンス」「開発ノウハウの属人化」という共通の課題を抱えている。

本拡張機能は、これらの課題を解決し、開発者が本来注力すべき付加価値の高いカスタマイズ作業に集中できる環境を提供することを目的とする。具体的には、煩雑な追従作業やコンフリクト解消を半自動化し、カスタマイズの意図を可視化・共有することで、開発の生産性とメンテナンス性を飛躍的に向上させる。

#### 1.2. 対象ユーザー

- OSS をベースとしたカスタマイズ開発を行う開発者
- OSS プロジェクトのメンテナンス担当者
- 複数の開発者が関わる OSS カスタマイズプロジェクトのチーム

#### 1.2. 開発対象

Visual Studio Code 拡張機能

#### 1.3. 開発環境・技術スタック

- **開発言語:** TypeScript
- **プラットフォーム:** VS Code Extension API
- **Git 操作:** Node.js child_process または simple-git ライブラリ
- **UI:** VS Code TreeView、Webview、コマンドパレット
- **データ永続化:** ローカル JSON ファイル（`.oss-assist/` ディレクトリ）

#### 1.4. 主要機能一覧

1.  **上流 OSS の変更監視:** ベースとしている OSS の変更を監視し、開発者に通知する。
2.  **カスタマイズカタログ管理:** 独自に加えた変更点を一覧化し、その「意図」を記録・管理する。
3.  **ワークフロー自動化:** 「上流の変更を取り込む」といった定型作業を自動化する。
4.  **ルールベースの自動コンフリクト解消:** ユーザーが定義したルールに基づき、特定パターンのコンフリクトを自動で解消する。

### 2. 機能要件

#### 2.1. 共通設定

本拡張機能の動作に必要な基本設定を行う。設定はリポジトリ内の専用ファイル（例: `.oss-assist/config.json`）に保存し、チーム間で共有可能とする。

- **UI:** コマンドパレットから開く専用の「拡張機能設定ページ」（Webview）
- **設定項目:**
  - **上流 OSS リポジトリ URL:** 追従対象となるオリジナルの OSS の Git リポジトリ URL。
  - **追跡する上流ブランチ名:** 追従の基準とする上流リポジトリのブランチ名（例: `main`, `develop`）。
  - **自社の開発ベースブランチ:** カスタマイズ開発の起点となる自社リポジトリのブランチ名。
  - **その他:** 変更監視の頻度、通知レベルなど。

#### 2.2. 機能 1: 上流 OSS の変更監視

- **UI:** VS Code サイドバーに専用のビューを設ける。
  - **ダッシュボード・ビュー:** プロジェクトの全体状況を俯瞰する。
  - **上流の変更履歴ビュー:** 上流リポジトリのコミット履歴をリスト表示する。
- **要件:**
  - 設定された頻度で、上流リポジトリの変更を自動的に`git fetch`する。
  - 自社の開発ベースブランチが、追跡対象の上流ブランチから何件遅れているか（Behind）をダッシュボード・ビューに表示する。
  - 未取得のコミット履歴を、上流の変更履歴ビューに一覧表示する。各コミットをクリックすると、変更内容の詳細（メッセージ、変更ファイル）が確認できること。

#### 2.3. 機能 2: カスタマイズカタログ管理

- **UI:**
  - **カスタマイズカタログ・ビュー:** サイドバーに、現在のカスタマイズ箇所を一覧表示する。
  - **カスタマイズ編集ページ:** コマンドパレットやビューから開く専用ページ（Webview）。
- **要件:**
  - 上流ブランチと自社ブランチの差分を解析し、カスタマイズ箇所を抽出してカタログファイル（JSON 形式など）に記録するコマンドを提供する。
  - カタログファイルの内容を、カスタマイズカタログ・ビューにツリー形式で表示する。
  - ビューの項目をクリックすると、エディタで該当コード箇所にジャンプできること。
  - カスタマイズ編集ページにて、各カスタマイズ箇所に対して以下のメタ情報を付与・編集できること。
    - 変更理由（自由記述）
    - 関連チケット URL/ID
    - 担当者
    - カスタマイズのカテゴリ（例: UI 変更, 機能追加）

#### 2.4. 機能 3: ワークフロー自動化

- **UI:** ダッシュボード・ビュー内のボタン、またはコマンドパレットから実行する。
- **要件:**
  - 「上流の変更を取り込む」ワークフローを実装する。
  - 本ワークフロー実行時、バックグラウンドで追跡対象の上流ブランチを現在のブランチにマージ (`git merge`) またはリベース (`git rebase`) する処理を行う。
  - 処理中にコンフリクトが発生した場合は、後述の「自動コンフリクト解消」機能を呼び出す。

#### 2.5. 機能 4: ルールベースの自動コンフリクト解消

- **UI:** コマンドパレットから開く専用の「自動コンフリクト解消ルール設定ページ」（Webview）。
- **要件:**
  - コンフリクトを自動解消するためのルールを定義・一覧・編集・削除できる UI を提供する。
  - ルールは以下の要素で構成される。
    - **ファイルパス・パターン:** 対象とするファイルやディレクトリを glob 形式で指定（例: `src/assets/**/*.css`）。
    - **解消戦略:** 現バージョンでは「**常にカスタマイズ側（`ours`）の変更を優先する**」固定とする。
  - 定義したルールは、リポジトリ内の専用ファイル（例: `.oss-assist/merge-rules.json`）に保存する。
  - ワークフロー実行時にコンフリクトが発生したファイルが、いずれかのルールにマッチした場合、システムは自動で`git checkout --ours <file-path>`を実行し、コンフリクトを解消する。
  - ルールにマッチしなかったファイルのコンフリクトは、VS Code 標準のマージエディタを開き、ユーザーに手動での解決を促す。

### 3. UI/UX 要件

- VS Code の標準的な UI コンポーネント（サイドバー、Webview、ステータスバー、通知ポップアップ）を活用し、直感的で一貫性のある操作性を提供する。
- サイドバーのダッシュボードには、最も重要な情報（追従状況など）と、次に行うべきアクション（ワークフロー実行ボタン）を分かりやすく配置する。
- 時間のかかる Git 操作や解析処理は非同期で実行し、進捗をステータスバーに表示するなどして、UI のフリーズを避ける。

#### 3.1. サイドバー UI 設計仕様

サイドバーには**常時参照が必要な情報**と**頻繁にアクセスする操作**を配置する。

##### 3.1.1. OSS Merge Assistant ビュー

**配置場所:** VS Code エクスプローラーサイドバー内の専用ビュー

**表示内容:**

```
📊 OSS Merge Assistant
├─ 🎯 Project Status
│   ├─ Upstream: origin/main ↑ 12 commits behind
│   ├─ Last Sync: 2025-10-20 14:30
│   └─ 🔄 [Sync Now] ボタン
├─ 📋 Quick Actions
│   ├─ 🔍 Scan Customizations
│   ├─ ⚙️ Configure Rules
│   └─ 📝 View Full Settings
├─ 📁 Recent Customizations (最新5件)
│   ├─ src/components/Header.tsx (UI改修)
│   ├─ config/database.json (設定変更)
│   └─ 📄 [View All] リンク
└─ ⚠️ Alerts
    ├─ 🔥 3 unresolved conflicts
    └─ 💡 2 new upstream features available
```

**TreeView 構造:**

- **Project Status**: 折りたたみ不可、常時表示
- **Quick Actions**: ワンクリックで実行可能なアクション
- **Recent Customizations**: 最近の変更箇所をクリックでジャンプ
- **Alerts**: 注意が必要な項目をバッジ表示

**インタラクション:**

- ツリー項目クリック → 該当ファイルを開く
- ボタンクリック → 対応するコマンド実行
- 右クリックメニュー → 詳細アクション（削除、編集など）

##### 3.1.2. 上流変更履歴ビュー

**配置場所:** 同じサイドバー内の第 2 ビュー

**表示内容:**

```
📈 Upstream Changes
├─ 🔍 [Filter] [Latest 20] ドロップダウン
├─ commit abc1234 (2 days ago)
│   ├─ feat: Add user authentication
│   ├─ 📁 3 files changed (+45 -12)
│   └─ 👤 john.doe@example.com
├─ commit def5678 (3 days ago)
│   ├─ fix: Resolve memory leak issue
│   ├─ 📁 2 files changed (+8 -3)
│   └─ 👤 jane.smith@example.com
└─ 📄 [Load More] ボタン
```

**特徴:**

- コミット情報を時系列で表示
- ファイル変更数と作者を表示
- クリックで詳細 diff 表示（エディタまたは Webview）

#### 3.2. Webview UI 設計仕様

Webview には**設定・編集・詳細表示**といった**複雑な操作**を配置する。

##### 3.2.1. メイン設定ページ

**アクセス方法:**

- コマンドパレット: `OSS Merge Assistant: Open Settings`
- サイドバー: Quick Actions > "📝 View Full Settings"

**ページ構成:**

```
[タブナビゲーション]
┌─ Basic Settings ─┬─ Merge Rules ─┬─ Advanced ─┐
│                  │                │            │
│ ┌─ Repository Configuration ─────────────────┐ │
│ │ Upstream Repository URL:                  │ │
│ │ [https://github.com/original/repo.git]    │ │
│ │                                           │ │
│ │ Target Branch: [main ▼]                   │ │
│ │ Local Base Branch: [develop ▼]            │ │
│ │                                           │ │
│ │ Sync Frequency: [Daily ▼]                 │ │
│ │ □ Auto-sync on VS Code startup            │ │
│ └───────────────────────────────────────────┘ │
│                                               │
│ ┌─ Notification Settings ──────────────────┐  │
│ │ □ Show notification for new upstream     │  │
│ │ □ Show notification for conflicts        │  │
│ │ □ Show notification for successful sync  │  │
│ └──────────────────────────────────────────┘  │
│                                               │
│ [Save Settings] [Reset to Default]            │
└───────────────────────────────────────────────┘
```

**特徴:**

- フォーム形式での設定編集
- リアルタイム検証とエラー表示
- 設定変更のプレビュー機能

##### 3.2.2. マージルール設定ページ

**アクセス方法:**

- メイン設定の "Merge Rules" タブ
- サイドバー: Quick Actions > "⚙️ Configure Rules"

**ページ構成:**

```
┌─ Conflict Resolution Rules ─────────────────────────┐
│                                                     │
│ [+ Add New Rule] [Import Rules] [Export Rules]      │
│                                                     │
│ ┌─ Rule #1 ─────────────────────────┐ [Edit] [🗑️] │
│ │ Name: CSS/Style Files             │              │
│ │ Pattern: src/**/*.{css,scss,less} │              │
│ │ Strategy: Keep Ours (Custom)      │              │
│ │ Status: ✅ Active                 │              │
│ └───────────────────────────────────┘              │
│                                                     │
│ ┌─ Rule #2 ─────────────────────────┐ [Edit] [🗑️] │
│ │ Name: Configuration Files         │              │
│ │ Pattern: config/**/*.json         │              │
│ │ Strategy: Keep Ours (Custom)      │              │
│ │ Status: ⏸️ Disabled               │              │
│ └───────────────────────────────────┘              │
│                                                     │
│ ┌─ Add New Rule ────────────────────────────────────┐
│ │ Rule Name: [                    ]                │
│ │ File Pattern: [                ]                 │
│ │ Resolution Strategy: [Keep Ours ▼]               │
│ │ □ Enable this rule immediately                   │
│ │                                                  │
│ │ [Add Rule] [Cancel]                              │
│ └──────────────────────────────────────────────────┘
└─────────────────────────────────────────────────────┘
```

**特徴:**

- ルールの一覧表示と管理
- ドラッグ&ドロップでの優先順位変更
- パターンのリアルタイム検証
- テスト機能（パターンマッチングの確認）

##### 3.2.3. カスタマイズカタログ詳細ページ

**アクセス方法:**

- サイドバーからカスタマイズ項目をクリック
- コマンドパレット: `OSS Merge Assistant: View Customizations`

**ページ構成:**

```
┌─ Customization Catalog ─────────────────────────────┐
│                                                     │
│ [🔍 Search] [Filter: All ▼] [Group by: File ▼]      │
│                                                     │
│ ┌─ src/components/Header.tsx ────────┐ [View Diff]  │
│ │ 📊 Changes: +15 lines, -3 lines   │              │
│ │ 🏷️ Category: UI Modification       │              │
│ │ 👤 Author: developer@company.com   │              │
│ │ 📅 Modified: 2025-10-22           │              │
│ │                                   │              │
│ │ 📝 Description:                   │              │
│ │ "Added company logo and custom    │              │
│ │  branding to header component"    │              │
│ │                                   │              │
│ │ 🔗 Related:                       │              │
│ │ • Issue #123: Header redesign     │              │
│ │ • Ticket: JIRA-456               │              │
│ │                                   │              │
│ │ [Edit Metadata] [View in Editor]  │              │
│ └───────────────────────────────────┘              │
│                                                     │
│ ┌─ config/database.json ─────────────┐ [View Diff] │
│ │ 📊 Changes: +5 lines, -1 line     │              │
│ │ 🏷️ Category: Configuration        │              │
│ │ 👤 Author: admin@company.com       │              │
│ │ 📅 Modified: 2025-10-20           │              │
│ │                                   │              │
│ │ 📝 Description:                   │              │
│ │ "Updated database connection      │              │
│ │  settings for production"         │              │
│ │                                   │              │
│ │ [Edit Metadata] [View in Editor]  │              │
│ └───────────────────────────────────┘              │
└─────────────────────────────────────────────────────┘
```

**特徴:**

- カード形式での情報表示
- 検索・フィルタリング機能
- 差分表示機能
- メタデータ編集機能

##### 3.2.4. コンフリクト解決支援ページ

**アクセス方法:**

- コンフリクト発生時に自動表示
- サイドバーの Alerts からアクセス

**ページ構成:**

```
┌─ Conflict Resolution Assistant ─────────────────────┐
│                                                     │
│ ⚠️ 3 conflicts detected during upstream merge       │
│                                                     │
│ ┌─ src/utils/helper.js ─────────────┐ [Resolve]    │
│ │ 🤖 Auto-resolution: Available     │              │
│ │ 📋 Rule: Keep Ours (Custom Logic) │              │
│ │ 🔍 Preview changes before apply   │              │
│ │                                   │              │
│ │ [Apply Auto-Resolution]           │              │
│ └───────────────────────────────────┘              │
│                                                     │
│ ┌─ src/components/Button.tsx ───────┐ [Resolve]    │
│ │ 🚫 Auto-resolution: Not Available │              │
│ │ 💡 Suggestion: Manual review      │              │
│ │ 📁 Open in merge editor           │              │
│ │                                   │              │
│ │ [Open Merge Editor]               │              │
│ └───────────────────────────────────┘              │
│                                                     │
│ [Resolve All Auto] [Skip All] [Cancel Merge]       │
└─────────────────────────────────────────────────────┘
```

#### 3.3. UI コンポーネント使い分け指針

##### サイドバー（TreeView）が適している場面:

- ✅ **常時参照が必要な情報** (プロジェクト状態、進捗)
- ✅ **階層構造を持つデータ** (ファイルツリー、カテゴリ分類)
- ✅ **ワンクリックアクション** (ファイルジャンプ、簡単な操作)
- ✅ **リアルタイム更新が必要** (ステータス、アラート)
- ✅ **VS Code の他機能と連携** (エディタとの連動)

##### Webview が適している場面:

- ✅ **複雑なフォーム入力** (設定、ルール定義)
- ✅ **リッチな表示** (差分表示、カード型レイアウト)
- ✅ **多段階の操作** (ウィザード、段階的設定)
- ✅ **データの詳細編集** (メタデータ、詳細説明)
- ✅ **一時的な作業** (コンフリクト解決、一括操作)

##### コマンドパレットが適している場面:

- ✅ **キーボードショートカット** (パワーユーザー向け)
- ✅ **検索可能なアクション** (機能の発見性)
- ✅ **一発実行の処理** (スキャン、同期、リセット)

この使い分けにより、ユーザーは用途に応じて最適なインターフェースでタスクを実行できます。

### 4. 非機能要件

- **パフォーマンス:** 拡張機能の常駐プロセスが、VS Code 本体や他の拡張機能のパフォーマンスに悪影響を与えないこと。
- **設定の永続化と共有:** 本拡張機能に関するすべての設定（基本設定、解消ルール、カタログ情報）は、リポジトリ内の特定のディレクトリにファイルとして保存し、Git を通じてチームメンバー間で共有・バージョン管理できる設計とする。
- **セキュリティ:** 外部サービス（Git リポジトリ）への接続情報は、VS Code の認証機能や OS のキーチェーンを利用し、安全に取り扱うこと。

### 5. 技術仕様

#### 5.1. 使用する VS Code Extension API

- **TreeDataProvider:** サイドバービューの実装
- **Webview:** 設定ページとカスタマイズ編集ページの実装
- **Commands:** コマンドパレットでの機能実行
- **StatusBarItem:** 進捗表示
- **FileSystemWatcher:** ローカルファイル変更の監視
- **WorkspaceConfiguration:** ユーザー設定の管理

#### 5.2. Git 操作の実装方針

- **ライブラリ:** `simple-git` を使用（型安全性とエラーハンドリング）
- **権限:** リポジトリの読み取り・書き込み権限が必要
- **並行処理:** Git 操作は非同期で実行し、UI のブロックを防ぐ

#### 5.3. データ永続化仕様

```
.oss-assist/
├── config.json          # 基本設定
├── merge-rules.json     # コンフリクト解消ルール
├── customizations/      # カスタマイズカタログ
│   ├── catalog.json     # カタログ一覧
│   └── metadata/        # 各カスタマイズのメタ情報
└── cache/              # 一時データ（上流変更情報など）
```

### 6. エラーハンドリング要件

#### 6.1. ネットワーク関連エラー

- **上流リポジトリへの接続失敗:** ユーザーに通知し、オフラインモードで動作継続
- **認証エラー:** 認証情報の再設定を促すガイダンス表示

#### 6.2. Git 操作エラー

- **マージ・リベース失敗:** 操作前の状態への自動ロールバック機能
- **コンフリクト解消失敗:** 手動解決モードへの切り替え
- **ローカル変更の競合:** 作業内容の退避（stash）機能

#### 6.3. データ整合性エラー

- **設定ファイル破損:** デフォルト設定での復旧機能
- **カタログデータ不整合:** 再構築機能の提供

### 7. 段階的実装計画

#### 7.1. Phase 1: MVP（最小実行可能製品）

**開発期間:** 2-3 週間  
**優先度:** 高  
**目標:** ユーザーが拡張機能の価値を実感できる最小限の機能を提供

##### 7.1.1. MVP 核心機能

**1. 基本設定機能（必須）**

- 上流リポジトリ URL の設定（Webview）
- 追跡ブランチの指定
- 設定の永続化（`.oss-assist/config.json`）

**2. 上流変更確認機能（必須）**

- 手動での `git fetch` 実行
- Behind 状況の表示（サイドバー）
- 未取得コミット一覧の表示

**3. 差分可視化機能（必須）**

- 上流との差分ファイル一覧
- 簡易的なカスタマイズ箇所の抽出
- ファイルクリックでエディタジャンプ

##### 7.1.2. MVP UI 仕様

**サイドバー（簡易版）:**

```
📊 OSS Merge Assistant
├─ 🎯 Status
│   ├─ Upstream: ↑ 5 commits behind
│   └─ Last Check: Manual
├─ 🔄 Actions
│   ├─ [Check Updates] ボタン
│   └─ [Open Settings] ボタン
└─ 📁 Modified Files (3)
    ├─ src/components/Header.tsx
    ├─ config/app.json
    └─ [View All Differences]
```

**設定ページ（最小版）:**

```
┌─ Basic Setup ─────────────────────────┐
│ Upstream Repository URL:              │
│ [https://github.com/original/repo.git] │
│                                       │
│ Target Branch: [main ▼]               │
│                                       │
│ [Save Settings] [Test Connection]     │
└───────────────────────────────────────┘
```

##### 7.1.3. MVP 技術スタック

**最小限の依存関係:**

- VS Code Extension API のみ
- Node.js 標準ライブラリ（child_process for git）
- 外部ライブラリは使用しない（simple-git 等は Phase 2 で導入）

**実装範囲:**

- TreeDataProvider（サイドバー）
- Webview（設定ページのみ）
- Commands（基本的なアクション）
- WorkspaceConfiguration（設定管理）

##### 7.1.4. MVP 成功指標

**機能的指標:**

- ✅ 上流リポジトリとの接続確認ができる
- ✅ Behind 状況が正確に表示される
- ✅ カスタマイズファイルが特定できる
- ✅ エディタでファイルジャンプができる

**体験的指標:**

- ✅ 初回セットアップが 5 分以内で完了
- ✅ 上流の変更状況が一目で分かる
- ✅ VS Code の標準操作と統一感がある

##### 7.1.5. MVP 実装タスク

**Week 1: 基盤構築**

1. 拡張機能の基本構造作成
2. TreeDataProvider の実装
3. 基本設定 Webview の作成
4. Git コマンド実行の基本ロジック

**Week 2: 核心機能実装**

1. 上流リポジトリとの接続確認
2. Behind 状況の取得・表示
3. ファイル差分の抽出ロジック
4. サイドバーでのファイル一覧表示

**Week 3: 統合・テスト**

1. UI/UX の調整
2. エラーハンドリングの基本実装
3. 実際の OSS プロジェクトでのテスト
4. ドキュメント作成

##### 7.1.6. MVP 除外機能

**Phase 2 以降に延期する機能:**

- ❌ 自動的な変更監視（定期 fetch）
- ❌ ワークフロー自動化（マージ・リベース）
- ❌ 自動コンフリクト解消
- ❌ カスタマイズメタデータの詳細管理
- ❌ 通知機能
- ❌ 高度なエラーハンドリング

**理由:** MVP では「価値実証」に集中し、自動化は手動操作で価値を確認後に実装

#### 7.2. Phase 2: 自動化機能

**開発期間:** 3-4 週間  
**優先度:** 中  
**前提条件:** MVP での価値実証が完了

**主要機能:**

1. 自動的な変更監視（定期 fetch）
2. ワークフロー自動化（マージ・リベース）
3. カスタマイズカタログの詳細管理
4. 通知システム

**完了目標:** 基本的な自動化による作業効率向上

#### 7.3. Phase 3: 高度な機能

**開発期間:** 4-6 週間  
**優先度:** 低  
**前提条件:** Phase 2 での自動化が安定稼働

**主要機能:**

1. ルールベースの自動コンフリクト解消
2. 高度なエラーハンドリング
3. チーム連携機能
4. 統計・レポート機能

**完了目標:** 完全自動化による開発体験の向上

**優先度: 低**

1. ルールベースの自動コンフリクト解消
2. 高度なエラーハンドリング
3. チーム連携機能

**完了目標:** 完全自動化による開発体験の向上

### 8. テスト要件

#### 8.1. 単体テスト

- Git 操作ロジック
- データ永続化機能
- コンフリクト解消ロジック

#### 8.2. 統合テスト

- VS Code Extension API との連携
- 実際の Git リポジトリでの動作確認

#### 8.3. E2E テスト

- 完全なワークフロー（設定 → 監視 → 取り込み → 解消）
- 複数の上流リポジトリパターンでの動作確認

---
